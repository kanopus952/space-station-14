using System.Numerics;
using System.Text;
using Content.Client.GameTicking.Managers;
using Content.Client.Resources;
using Content.Shared._Sunrise.Roadmap;
using Content.Shared._Sunrise.SunriseCCVars;
using Content.Shared._Sunrise.Tutorial.Prototypes;
using Robust.Client.AutoGenerated;
using Robust.Client.Graphics;
using Robust.Client.ResourceManagement;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.CustomControls;
using Robust.Client.UserInterface.XAML;
using Robust.Shared.Configuration;
using Robust.Shared.Prototypes;

namespace Content.Client._Sunrise.Tutorial;

[GenerateTypedNameReferences]
public sealed partial class TutorialWindow : DefaultWindow
{
    [Dependency] private readonly IConfigurationManager _cfg = default!;
    [Dependency] private readonly IPrototypeManager _prototype = default!;
    [Dependency] private readonly ILocalizationManager _loc = default!;
    [Dependency] private readonly IResourceCache _resourceCache = default!;
    [Dependency] private readonly IEntitySystemManager _entSys = default!;
    public Action<TutorialSequencePrototype>? OnTutorialButtonPressed;
    private readonly ClientGameTicker _gameTicker;

    public TutorialWindow()
    {
        IoCManager.InjectDependencies(this);
        RobustXamlLoader.Load(this);
        _gameTicker = _entSys.GetEntitySystem<ClientGameTicker>();

        _gameTicker.LobbyStatusUpdated += UpdateRoundState;
        PopulateButtons();
    }

    private void PopulateButtons()
    {
        var roundNotStarted = !_gameTicker.IsGameStarted;
        var deniedText = Loc.GetString("round-is-not-ready");

        foreach (var proto in _prototype.EnumeratePrototypes<TutorialSequencePrototype>())
        {
            var entry = new TutorialEntry(proto, OnTutorialButtonPressed);

            if (roundNotStarted)
                entry.SetDenied(true, deniedText);

            ButtonContainer.AddChild(entry);
        }
    }

    private void UpdateRoundState()
    {
        foreach (var child in ButtonContainer.Children)
        {
            if (child is TutorialEntry entry)
                entry.SetDenied(!_gameTicker.IsGameStarted);
        }
    }
}
